<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì - ì†Œì„¤ ì‹œê°„íë¦„ ë¼ë²¨ë§ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <h1>ğŸ”§ ê´€ë¦¬ì í˜ì´ì§€</h1>
                <div class="user-info" id="adminControls" style="display: none;">
                    <span>ê´€ë¦¬ì</span>
                    <button id="logoutBtn" class="btn btn-small">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </header>

        <main>
            <!-- ë¡œê·¸ì¸ í¼ -->
            <section id="adminLoginSection" class="admin-login-section">
                <div class="login-box">
                    <h2>ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
                    <form id="adminLoginForm">
                        <div class="form-group">
                            <label for="adminKey">ê´€ë¦¬ì í‚¤</label>
                            <input type="password" id="adminKey" name="key" placeholder="ê´€ë¦¬ì í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
                        </div>
                        <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button>
                    </form>
                    <p id="adminLoginError" class="error-message"></p>
                    <a href="index.html" class="btn btn-secondary" style="margin-top: 1rem;">â† ë¼ë²¨ëŸ¬ ë¡œê·¸ì¸ìœ¼ë¡œ</a>
                </div>
            </section>

            <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
            <div id="adminDashboard" style="display: none;">
                <!-- ë¼ë²¨ëŸ¬ ê´€ë¦¬ -->
                <section class="admin-section">
                    <h2>ğŸ‘¥ ë¼ë²¨ëŸ¬ ê´€ë¦¬</h2>
                    
                    <div class="add-labeler-form">
                        <h3>ìƒˆ ë¼ë²¨ëŸ¬ ì¶”ê°€</h3>
                        <form id="addLabelerForm" class="inline-form">
                            <input type="text" id="newLabelerNickname" placeholder="ë¼ë²¨ëŸ¬ ë³„ëª…" required>
                            <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
                        </form>
                    </div>
                    
                    <div class="labelers-list">
                        <h3>ë¼ë²¨ëŸ¬ ëª©ë¡</h3>
                        <table id="labelersTable">
                            <thead>
                                <tr>
                                    <th>ë³„ëª…</th>
                                    <th>ê°œì¸ í‚¤</th>
                                    <th>ì§„í–‰ë¥ </th>
                                    <th>ìƒì„±ì¼</th>
                                    <th>ì‘ì—…</th>
                                </tr>
                            </thead>
                            <tbody id="labelersTableBody">
                                <tr><td colspan="5" class="loading">ë¡œë”© ì¤‘...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- ì‘í’ˆ ê´€ë¦¬ -->
                <section class="admin-section">
                    <h2>ğŸ“š ì‘í’ˆ ê´€ë¦¬</h2>
                    
                    <div class="import-json-form">
                        <h3>ìƒˆ ì‘í’ˆ ì¶”ê°€ (JSON íŒŒì¼)</h3>
                        <form id="importJsonForm" class="inline-form" enctype="multipart/form-data">
                            <input type="file" id="jsonFile" name="json_file" accept=".json" required>
                            <button type="submit" class="btn btn-primary">ì—…ë¡œë“œ & ë³‘í•©</button>
                        </form>
                        <p class="help-text">
                            sampled_passages.json í˜•ì‹ì˜ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”. 
                            ê¸°ì¡´ì— ì—†ëŠ” R_XXX ì‘í’ˆë§Œ ì¶”ê°€ë©ë‹ˆë‹¤.
                        </p>
                    </div>
                    
                    <div id="importResult" class="import-result" style="display: none;"></div>
                </section>

                <!-- ì „ì²´ ì§„í–‰ í˜„í™© -->
                <section class="admin-section">
                    <h2>ğŸ“Š ì „ì²´ ì§„í–‰ í˜„í™©</h2>
                    <div id="allProgressContainer">
                        <p class="loading">ë¡œë”© ì¤‘...</p>
                    </div>
                </section>

                <!-- ê²°ê³¼ ë‚´ë³´ë‚´ê¸° -->
                <section class="admin-section">
                    <h2>ğŸ“¤ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</h2>
                    <p class="help-text" style="margin-bottom: 1rem;">
                        ëª¨ë“  ë¼ë²¨ëŸ¬ì˜ ì‘ì—… ë°ì´í„°ë¥¼ ZIP íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.<br>
                        (labelers í´ë” + users.json + master_passages.json)
                    </p>
                    <button id="exportResultsBtn" class="btn btn-primary">
                        ğŸ“¦ ë¼ë²¨ë§ ê²°ê³¼ ZIPìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
                    </button>
                </section>

                <!-- ê³µì§€ì‚¬í•­ ê´€ë¦¬ -->
                <section class="admin-section">
                    <h2>ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h2>
                    
                    <div class="add-announcement-form">
                        <h3>ìƒˆ ê³µì§€ì‚¬í•­ ì‘ì„±</h3>
                        <form id="addAnnouncementForm">
                            <div class="form-group">
                                <input type="text" id="announcementTitle" placeholder="ê³µì§€ì‚¬í•­ ì œëª©" required>
                            </div>
                            <div class="form-group">
                                <textarea id="announcementContent" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..." rows="4" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">ê³µì§€ì‚¬í•­ ë“±ë¡</button>
                        </form>
                    </div>
                    
                    <div class="announcements-list-admin">
                        <h3>ê³µì§€ì‚¬í•­ ëª©ë¡</h3>
                        <div id="adminAnnouncementsList" class="announcements-container-admin">
                            <p class="loading">ë¡œë”© ì¤‘...</p>
                        </div>
                    </div>
                </section>
            </div>
        </main>

        <footer>
            <p>Based on Ted Underwood's "Why Literary Time is Measured in Minutes"</p>
        </footer>
    </div>

    <script src="js/common.js"></script>
    <script>
        // ê´€ë¦¬ì ë¡œê·¸ì¸ í¼
        document.getElementById('adminLoginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const key = document.getElementById('adminKey').value;
            const errorEl = document.getElementById('adminLoginError');
            
            try {
                const response = await api.adminLogin(key);
                
                if (response.success) {
                    sessionStorage.setItem('is_admin', 'true');
                    showAdminDashboard();
                } else {
                    errorEl.textContent = response.message;
                }
            } catch (error) {
                errorEl.textContent = 'ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        });

        // ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ í‘œì‹œ
        async function showAdminDashboard() {
            document.getElementById('adminLoginSection').style.display = 'none';
            document.getElementById('adminDashboard').style.display = 'block';
            document.getElementById('adminControls').style.display = 'flex';
            
            await loadLabelers();
            await loadAllProgress();
            await loadAdminAnnouncements();
        }

        // ë¼ë²¨ëŸ¬ ëª©ë¡ ë¡œë“œ
        async function loadLabelers() {
            const response = await api.getLabelers();
            const tbody = document.getElementById('labelersTableBody');
            
            if (response.success) {
                const labelers = response.data;
                
                if (labelers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="no-data">ë“±ë¡ëœ ë¼ë²¨ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }
                
                tbody.innerHTML = labelers.map(labeler => `
                    <tr>
                        <td><strong>${escapeHtml(labeler.nickname)}</strong></td>
                        <td>
                            <code class="key-code">${labeler.key}</code>
                            <button class="btn btn-tiny" onclick="copyToClipboard('${labeler.key}')">ë³µì‚¬</button>
                        </td>
                        <td>
                            <div class="mini-progress-bar">
                                <div class="mini-progress-fill" style="width: ${labeler.progress.percentage}%"></div>
                            </div>
                            <span>${labeler.progress.completed}/${labeler.progress.total} (${labeler.progress.percentage}%)</span>
                        </td>
                        <td>${labeler.created_at || '-'}</td>
                        <td>
                            <button class="btn btn-small btn-danger" onclick="deleteLabeler('${labeler.id}', '${escapeHtml(labeler.nickname)}')">
                                ì‚­ì œ
                            </button>
                        </td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `<tr><td colspan="5" class="error">${response.message}</td></tr>`;
            }
        }

        // ì „ì²´ ì§„í–‰ í˜„í™© ë¡œë“œ
        async function loadAllProgress() {
            const container = document.getElementById('allProgressContainer');
            const response = await api.getAllProgress();
            
            if (response.success) {
                const data = response.data;
                
                if (data.length === 0) {
                    container.innerHTML = '<p class="no-data">ë“±ë¡ëœ ë¼ë²¨ëŸ¬ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                container.innerHTML = `
                    <div class="progress-grid">
                        ${data.map(item => `
                            <div class="progress-card">
                                <h4>${escapeHtml(item.nickname)}</h4>
                                <div class="progress-bar-container">
                                    <div class="progress-bar" style="width: ${item.progress.percentage}%"></div>
                                </div>
                                <p>${item.progress.completed} / ${item.progress.total} (${item.progress.percentage}%)</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }

        // ë¼ë²¨ëŸ¬ ì¶”ê°€
        document.getElementById('addLabelerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nickname = document.getElementById('newLabelerNickname').value;
            
            const response = await api.addLabeler(nickname);
            
            if (response.success) {
                alert(`ë¼ë²¨ëŸ¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.\n\në³„ëª…: ${response.data.nickname}\nê°œì¸ í‚¤: ${response.data.key}\n\nì´ í‚¤ë¥¼ ë¼ë²¨ëŸ¬ì—ê²Œ ì „ë‹¬í•´ì£¼ì„¸ìš”.`);
                document.getElementById('newLabelerNickname').value = '';
                await loadLabelers();
                await loadAllProgress();
            } else {
                alert(response.message);
            }
        });

        // ë¼ë²¨ëŸ¬ ì‚­ì œ
        async function deleteLabeler(id, nickname) {
            if (!confirm(`ì •ë§ë¡œ "${nickname}" ë¼ë²¨ëŸ¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ë¼ë²¨ëŸ¬ì˜ ëª¨ë“  ë¼ë²¨ë§ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }
            
            const response = await api.deleteLabeler(id);
            
            if (response.success) {
                alert('ë¼ë²¨ëŸ¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadLabelers();
                await loadAllProgress();
            } else {
                alert(response.message);
            }
        }

        // JSON íŒŒì¼ ì—…ë¡œë“œ
        document.getElementById('importJsonForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('jsonFile');
            const resultEl = document.getElementById('importResult');
            
            if (!fileInput.files[0]) {
                alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const formData = new FormData();
            formData.append('json_file', fileInput.files[0]);
            formData.append('action', 'import_json');
            
            try {
                const response = await fetch('api.php', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                
                const result = await response.json();
                
                resultEl.style.display = 'block';
                
                if (result.success) {
                    resultEl.className = 'import-result success';
                    resultEl.textContent = result.message;
                    fileInput.value = '';
                    await loadLabelers();
                } else {
                    resultEl.className = 'import-result error';
                    resultEl.textContent = result.message;
                }
            } catch (error) {
                resultEl.className = 'import-result error';
                resultEl.textContent = 'ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        });

        // ê²°ê³¼ ë‚´ë³´ë‚´ê¸° (ZIP ë‹¤ìš´ë¡œë“œ)
        document.getElementById('exportResultsBtn').addEventListener('click', function() {
            // ì§ì ‘ ë‹¤ìš´ë¡œë“œ ë§í¬ë¡œ ì´ë™ (ZIP íŒŒì¼ ë°˜í™˜)
            window.location.href = 'api.php?action=export_results';
        });

        // ê³µì§€ì‚¬í•­ ëª©ë¡ ë¡œë“œ (ê´€ë¦¬ì)
        async function loadAdminAnnouncements() {
            const response = await api.getAnnouncements();
            const container = document.getElementById('adminAnnouncementsList');
            
            if (response.success) {
                const announcements = response.data;
                
                if (announcements.length === 0) {
                    container.innerHTML = '<p class="no-data">ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                container.innerHTML = announcements.map(ann => `
                    <div class="announcement-item-admin">
                        <div class="announcement-header-admin">
                            <strong>${escapeHtml(ann.title)}</strong>
                            <span class="announcement-date">${ann.created_at}</span>
                        </div>
                        <div class="announcement-content-admin">${escapeHtml(ann.content).replace(/\n/g, '<br>')}</div>
                        <button class="btn btn-small btn-danger" onclick="deleteAnnouncement(${ann.id}, '${escapeHtml(ann.title).replace(/'/g, "\\'")}')">
                            ì‚­ì œ
                        </button>
                    </div>
                `).join('');
            } else {
                container.innerHTML = `<p class="error">${response.message}</p>`;
            }
        }

        // ê³µì§€ì‚¬í•­ ì¶”ê°€
        document.getElementById('addAnnouncementForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('announcementTitle').value;
            const content = document.getElementById('announcementContent').value;
            
            const response = await api.addAnnouncement(title, content);
            
            if (response.success) {
                alert('ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                document.getElementById('announcementTitle').value = '';
                document.getElementById('announcementContent').value = '';
                await loadAdminAnnouncements();
            } else {
                alert(response.message);
            }
        });

        // ê³µì§€ì‚¬í•­ ì‚­ì œ
        async function deleteAnnouncement(id, title) {
            if (!confirm(`"${title}" ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }
            
            const response = await api.deleteAnnouncement(id);
            
            if (response.success) {
                alert('ê³µì§€ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                await loadAdminAnnouncements();
            } else {
                alert(response.message);
            }
        }

        // í´ë¦½ë³´ë“œ ë³µì‚¬
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }).catch(() => {
                prompt('í‚¤ë¥¼ ë³µì‚¬í•˜ì„¸ìš”:', text);
            });
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ë¡œê·¸ì•„ì›ƒ
        document.getElementById('logoutBtn').addEventListener('click', async function() {
            await api.logout();
            sessionStorage.removeItem('is_admin');
            location.reload();
        });

        // ì„¸ì…˜ í™•ì¸
        (async function() {
            const isAdmin = sessionStorage.getItem('is_admin');
            if (isAdmin === 'true') {
                const response = await api.checkSession();
                if (response.success && response.data.is_admin) {
                    showAdminDashboard();
                }
            }
        })();
    </script>
</body>
</html>
