<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¼ë²¨ë§ ì‘ì—… - ì†Œì„¤ ì‹œê°„íë¦„ ë¼ë²¨ë§ ì‹œìŠ¤í…œ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container labeling-container">
        <header>
            <div class="header-content">
                <a href="dashboard.html" class="back-link">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
                <div class="header-info">
                    <span id="currentDocInfo"></span>
                    <span id="progressInfo"></span>
                </div>
            </div>
        </header>

        <main class="labeling-main">
            <!-- ì™„ë£Œ ë©”ì‹œì§€ (ìˆ¨ê¹€ ìƒíƒœ) -->
            <div id="completionMessage" class="completion-message" style="display: none;">
                <h2>ğŸ‰ ëª¨ë“  ë¼ë²¨ë§ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                <p>ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œì—ì„œ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <a href="dashboard.html" class="btn btn-primary">ëŒ€ì‹œë³´ë“œë¡œ ì´ë™</a>
            </div>

            <!-- ë¼ë²¨ë§ ì¸í„°í˜ì´ìŠ¤ -->
            <div id="labelingInterface">
                <!-- ë©”íƒ€ë°ì´í„° í‘œì‹œ -->
                <div class="metadata-panel">
                    <div class="meta-item">
                        <span class="meta-label">ì‘í’ˆ</span>
                        <span id="metaTitle" class="meta-value"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ì‘ê°€</span>
                        <span id="metaAuthor" class="meta-value"></span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ë¬¸ë‹¨ ë²ˆí˜¸</span>
                        <span id="metaSegmentIdx" class="meta-value"></span>
                    </div>
                </div>

                <!-- í…ìŠ¤íŠ¸ í‘œì‹œ ì˜ì—­ -->
                <div class="text-panel">
                    <h3>ğŸ“œ í…ìŠ¤íŠ¸</h3>
                    <div id="segmentText" class="segment-text">
                        <p class="loading">ë¡œë”© ì¤‘...</p>
                    </div>
                    <div class="text-stats">
                        <span>ê¸€ì ìˆ˜: <strong id="charCount">-</strong></span>
                        <span>ë‹¨ì–´ ìˆ˜: <strong id="wordCount">-</strong></span>
                    </div>
                </div>

                <!-- ë¼ë²¨ë§ ì…ë ¥ í¼ -->
                <div class="labeling-form-panel">
                    <form id="labelingForm">
                        <input type="hidden" id="docKey" name="doc_key">
                        <input type="hidden" id="segmentIdx" name="segment_idx">
                        
                        <div class="form-row">
                            <div class="form-group required">
                                <label for="narratedtime">
                                    narratedtime (í•„ìˆ˜)
                                    <span class="tooltip" data-tip="ì´ ë¬¸ë‹¨ì—ì„œ ì„œìˆ ëœ ì‹œê°„ì˜ ì–‘(ë¶„ ë‹¨ìœ„). ì˜ˆ: 1ì‹œê°„ = 60. ì •ë‹µì´ ì—†ì„ ê²½ìš° -1 ì…ë ¥">?</span>
                                </label>
                                <input type="number" id="narratedtime" name="narratedtime" 
                                       step="0.1" min="-1" required placeholder="ë¶„ ë‹¨ìœ„ë¡œ ì…ë ¥ (-1: ì •ë‹µ ì—†ìŒ)">
                            </div>
                        </div>

                        <div class="form-row two-columns">
                            <div class="form-group">
                                <label for="ellipsistime">
                                    ellipsistime (ì„ íƒ)
                                    <span class="tooltip" data-tip="ìƒëµëœ ì‹œê°„(ë¶„ ë‹¨ìœ„). 'ë©°ì¹  í›„', 'ëª‡ ë…„ì´ ì§€ë‚˜' ë“±">?</span>
                                </label>
                                <input type="number" id="ellipsistime" name="ellipsistime" 
                                       step="0.1" min="0" value="0" placeholder="ë¶„ ë‹¨ìœ„">
                            </div>
                            <div class="form-group">
                                <label for="ellipsisphrase">ìƒëµ í‘œí˜„</label>
                                <input type="text" id="ellipsisphrase" name="ellipsisphrase" 
                                       placeholder="ì˜ˆ: 'ë©°ì¹  í›„'">
                            </div>
                        </div>

                        <div class="form-row two-columns">
                            <div class="form-group">
                                <label for="subjectivetime">
                                    subjectivetime (ì„ íƒ)
                                    <span class="tooltip" data-tip="ì£¼ê´€ì ìœ¼ë¡œ ëŠê»´ì§€ëŠ” ì‹œê°„(ë¶„ ë‹¨ìœ„). íšŒìƒ, ê¿ˆ ë“±">?</span>
                                </label>
                                <input type="number" id="subjectivetime" name="subjectivetime" 
                                       step="0.1" min="0" value="0" placeholder="ë¶„ ë‹¨ìœ„">
                            </div>
                            <div class="form-group">
                                <label for="subjectivephrase">ì£¼ê´€ì  ì‹œê°„ í‘œí˜„</label>
                                <input type="text" id="subjectivephrase" name="subjectivephrase" 
                                       placeholder="ì˜ˆ: 'ê·¸ ì‹œì ˆì„ ë– ì˜¬ë¦¬ë©°'">
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="button" id="prevBtn" class="btn btn-secondary">
                                â† ì´ì „ ë¬¸ì¥
                            </button>
                            <button type="submit" id="nextBtn" class="btn btn-primary">
                                ì €ì¥ & ë‹¤ìŒ ë¬¸ì¥ â†’
                            </button>
                        </div>
                    </form>
                </div>

                <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
                <div class="navigation-panel">
                    <h4>ë¬¸ì¥ ë„¤ë¹„ê²Œì´ì…˜</h4>
                    <div id="segmentNav" class="segment-nav">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„± -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/common.js"></script>
    <script>
        let currentDocKey = null;
        let currentSegmentIdx = 0;
        let documentData = null;
        let allSegments = [];
        
        // Heartbeat debounce ê´€ë ¨ ë³€ìˆ˜
        let heartbeatTimeout = null;
        const HEARTBEAT_DEBOUNCE_MS = 10000; // 10ì´ˆ debounce

        // í˜ì´ì§€ ì´ˆê¸°í™”
        (async function init() {
            const key = localStorage.getItem('labeler_key');
            if (!key) {
                window.location.href = 'index.html';
                return;
            }

            // ì„¸ì…˜ í™•ì¸
            await api.login(key);

            // URLì—ì„œ ë¬¸ì„œ í‚¤ í™•ì¸
            const urlParams = new URLSearchParams(window.location.search);
            const docFromUrl = urlParams.get('doc');
            
            if (docFromUrl) {
                currentDocKey = decodeURIComponent(docFromUrl);
                await loadDocument(currentDocKey);
            } else {
                await loadNextUnlabeled();
            }
        })();

        // ë‹¤ìŒ ë¯¸ë¼ë²¨ë§ ë¬¸ì¥ ë¡œë“œ
        async function loadNextUnlabeled() {
            const response = await api.getNextSegment();
            
            if (response.success) {
                if (response.data === null) {
                    showCompletion();
                    return;
                }
                
                currentDocKey = response.data.doc_key;
                await loadDocument(currentDocKey);
                
                // ë¯¸ë¼ë²¨ë§ëœ ì²« ë¬¸ì¥ìœ¼ë¡œ ì´ë™
                const segmentIdx = response.data.segment_idx;
                navigateToSegment(segmentIdx);
            }
        }

        // ë¬¸ì„œ ë¡œë“œ
        async function loadDocument(docKey) {
            const response = await api.getSegments(docKey);
            
            if (response.success) {
                documentData = response.data;
                allSegments = documentData.segments || [];
                
                // ë©”íƒ€ë°ì´í„° í‘œì‹œ
                document.getElementById('metaTitle').textContent = 
                    documentData.metadata?.title || docKey;
                document.getElementById('metaAuthor').textContent = 
                    documentData.metadata?.author || '-';
                document.getElementById('currentDocInfo').textContent = 
                    `${documentData.metadata?.docid || ''} - ${documentData.metadata?.title || ''}`;
                
                // ë„¤ë¹„ê²Œì´ì…˜ ìƒì„±
                createNavigation();
                
                // ì²« ë²ˆì§¸ ë¯¸ë¼ë²¨ë§ ë¬¸ì¥ ì°¾ê¸°
                let firstUnlabeled = 0;
                for (let i = 0; i < allSegments.length; i++) {
                    if (allSegments[i].narratedtime === null) {
                        firstUnlabeled = i;
                        break;
                    }
                }
                
                navigateToSegment(firstUnlabeled);
            }
        }

        // ë„¤ë¹„ê²Œì´ì…˜ ìƒì„±
        function createNavigation() {
            const navEl = document.getElementById('segmentNav');
            navEl.innerHTML = '';
            
            allSegments.forEach((seg, idx) => {
                const btn = document.createElement('button');
                btn.className = 'nav-btn';
                btn.textContent = idx + 1;
                btn.title = `ë¬¸ë‹¨ ${idx + 1} (ì›ë³¸ idx: ${seg.idx})`;
                
                if (seg.narratedtime !== null) {
                    btn.classList.add('completed');
                }
                
                btn.addEventListener('click', () => navigateToSegment(idx));
                navEl.appendChild(btn);
            });
        }

        // íŠ¹ì • ë¬¸ì¥ìœ¼ë¡œ ì´ë™
        function navigateToSegment(idx) {
            if (idx < 0 || idx >= allSegments.length) return;
            
            currentSegmentIdx = idx;
            const segment = allSegments[idx];
            
            // Debounced heartbeat - 10ì´ˆ ë‚´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
            sendHeartbeat();
            
            // í…ìŠ¤íŠ¸ í‘œì‹œ
            document.getElementById('segmentText').innerHTML = 
                `<p>${escapeHtml(segment.text).replace(/\n/g, '<br>')}</p>`;
            
            // í†µê³„ í‘œì‹œ
            document.getElementById('charCount').textContent = segment.char_count || segment.text.length;
            document.getElementById('wordCount').textContent = segment.word_count || '-';
            document.getElementById('metaSegmentIdx').textContent = 
                `${idx + 1} / ${allSegments.length} (ì›ë³¸ idx: ${segment.idx})`;
            
            // ì§„í–‰ ìƒí™© í‘œì‹œ
            const completed = allSegments.filter(s => s.narratedtime !== null).length;
            document.getElementById('progressInfo').textContent = 
                `ì§„í–‰: ${completed}/${allSegments.length}`;
            
            // í¼ ê°’ ì„¤ì •
            document.getElementById('docKey').value = currentDocKey;
            document.getElementById('segmentIdx').value = idx;
            document.getElementById('narratedtime').value = segment.narratedtime ?? '';
            document.getElementById('ellipsistime').value = segment.ellipsistime ?? 0;
            document.getElementById('subjectivetime').value = segment.subjectivetime ?? 0;
            document.getElementById('ellipsisphrase').value = segment.ellipsisphrase ?? '';
            document.getElementById('subjectivephrase').value = segment.subjectivephrase ?? '';
            
            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                btn.classList.remove('current');
                if (i === idx) btn.classList.add('current');
            });
            
            // ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ìƒíƒœ
            document.getElementById('prevBtn').disabled = idx === 0;
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ
        function showCompletion() {
            document.getElementById('labelingInterface').style.display = 'none';
            document.getElementById('completionMessage').style.display = 'block';
        }

        // í¼ ì œì¶œ (ì €ì¥ & ë‹¤ìŒ)
        document.getElementById('labelingForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            // í•„ìˆ˜ ê°’ í™•ì¸
            if (!formData.get('narratedtime')) {
                alert('narratedtimeì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
                return;
            }
            
            try {
                const response = await api.saveLabel(formData);
                
                if (response.success) {
                    // í˜„ì¬ ë¬¸ì¥ ì™„ë£Œ í‘œì‹œ
                    allSegments[currentSegmentIdx].narratedtime = parseFloat(formData.get('narratedtime'));
                    
                    // ë„¤ë¹„ê²Œì´ì…˜ ì—…ë°ì´íŠ¸
                    const navBtns = document.querySelectorAll('.nav-btn');
                    if (navBtns[currentSegmentIdx]) {
                        navBtns[currentSegmentIdx].classList.add('completed');
                    }
                    
                    // ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ì´ë™
                    if (currentSegmentIdx < allSegments.length - 1) {
                        navigateToSegment(currentSegmentIdx + 1);
                    } else {
                        // í˜„ì¬ ë¬¸ì„œì˜ ëª¨ë“  ë¬¸ì¥ ì™„ë£Œ
                        // ë‹¤ìŒ ë¯¸ë¼ë²¨ë§ ë¬¸ì¥ ì°¾ê¸°
                        const nextUnlabeled = allSegments.findIndex(s => s.narratedtime === null);
                        
                        if (nextUnlabeled === -1) {
                            alert('ì´ ì‘í’ˆì˜ ëª¨ë“  ë¼ë²¨ë§ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                            window.location.href = 'dashboard.html';
                        } else {
                            navigateToSegment(nextUnlabeled);
                        }
                    }
                } else {
                    alert(response.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(error);
            }
        });

        // ì´ì „ ë²„íŠ¼
        document.getElementById('prevBtn').addEventListener('click', function() {
            if (currentSegmentIdx > 0) {
                navigateToSegment(currentSegmentIdx - 1);
            }
        });

        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', function(e) {
            // Alt + ì¢Œ/ìš° í™”ì‚´í‘œë¡œ ì´ë™
            if (e.altKey && e.key === 'ArrowLeft') {
                e.preventDefault();
                if (currentSegmentIdx > 0) {
                    navigateToSegment(currentSegmentIdx - 1);
                }
            } else if (e.altKey && e.key === 'ArrowRight') {
                e.preventDefault();
                if (currentSegmentIdx < allSegments.length - 1) {
                    navigateToSegment(currentSegmentIdx + 1);
                }
            }
        });
        
        // Debounced heartbeat ì „ì†¡
        function sendHeartbeat() {
            // ì´ì „ íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì·¨ì†Œí•˜ì§€ ì•ŠìŒ (debounce leading edge)
            if (heartbeatTimeout) return;
            
            // ì¦‰ì‹œ heartbeat ì „ì†¡
            api.heartbeat().catch(err => console.log('Heartbeat failed:', err));
            
            // ë‹¤ìŒ heartbeatê¹Œì§€ ëŒ€ê¸°
            heartbeatTimeout = setTimeout(() => {
                heartbeatTimeout = null;
            }, HEARTBEAT_DEBOUNCE_MS);
        }
    </script>
</body>
</html>
